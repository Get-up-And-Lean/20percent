# 0/9第01课：为什么我们要使用 Redis

### 1.1 导言

如果你从来没使用过 Redis 数据库，那你肯定会问，为什么我们要学 Redis数据库，我只使用 MySQL 或 Oracle 就够了。其实 Redis 虽叫数据库，可又不是传统意义上的关系型数据库，Redis 是一个高性能的 Key-Value 数据库。

首先我们先来讲一下 Redis 的历史。Redis 其实是作者 Salvatore Sanfilippo 为了解决实际问题而创造出来的。当时作者 Salvatore 有这么一个需求，就是多个网站不断向服务器发送页面，而服务器需要为每个网站保存一定数量的最新页面记录，同时通过网页将数据实时给用户看到。但是无论 Salvatore 如何优化，都很难在关系数据库里让小虚拟机处理大负荷的负载。最终他打算自己写一个内存数据库，能对列表的两端执行常数时间复杂度的弹出和推入操作，并加上子进程的持久化操作，于是 Redis 就诞生了。

到了今天，Redis 已经进入了成熟期。数以千计的开发者都在开发和使用这个数据库，Redis 拥有非常完善的文档。我记得第一次使用 Redis，是为了在保存有数十百万用户的关系数据库里对某个条件进行查询。大家知道，要想在几百万用户中找到某条数据，是很难通过关系数据库在十几秒查询到的。于是我选择了 Redis，在不断优化后每次操作可以控制在 1 秒钟甚至更短，带给我相当大的震撼。

本教程不但教给你一些基本的使用，同时也会根据我多年总结的技巧解决日常生产环境上优化和排错的问题。特别是后期的数据库优化和集群的讲解，希望对各位进行 Redis 开发有一定帮助。

### 1.2 认识 Redis

在 Redis 之前，很多互联网公司会使用 MySQL + Memcached 架构，这个架构虽然适合于海量数据存储，但随着业务的增加，会出现很多问题，例如，MySQL 数据库经常拆表，导致 Memcached 也不断扩容；同步问题；命中率低，导致直接穿透 Memcached 进入 DB 查询，DB 资源池是有限的，进而宕机。这些问题都会导致Memcached其实并不好用。

Redis 就在这种时代背景中产生，你会发现 Memcached 遇到的问题都被 Redis 给解决了。如果你用过 Memcached，你就会感受到 Redis 绝对不是简单的 Key-Value 数据，还有 List、Set、哈希等各种数据类型的存储，同时支持冷热备份和主从复制，不但解决了数据库的容错，还能轻易地将数据分布到多个 Redis 实例中。

#### 1. Redis 特性

那么 Redis 有哪些具体特性呢？大致可分为如下八大特性。

- **速度极快**。官方给出的数据是 10 万次 ops 的读写，这主要归功于这些数据都存在于内存中。由于 Redis 是开源的，当你打开源代码，就会发现 Redis 都是用 C 语言写的，C 语言是最接近计算机语言的代码，而且只有区区 5 万行，保证了 Redis 的速度。同时一个 Redis 只是一个单线程，其真正的原因还是因为单线程在内存中是效率最高的。
- **持久化**。Redis 的持久化可以保证将内存中的数据每隔一段时间就保存于磁盘中，重启的时候会再次加载到内存。持久化方式是 RDB 和 AOF。
- **支持多种数据结构**。分别支持哈希、集合、BitMaps，还有位图（多用于活跃用户数等统计）、HyperLogLog（超小内存唯一值计数，由于只有 12K，是有一定误差范围的）、GEO（地理信息定位）。
- **支持多种编程语言**。支持 Java、PHP、Python、Ruby、Lua、Node.js。
- **功能丰富**。如发布订阅、Lua 脚本、事务、Pipeline（管道，即当指令到达一定数量后，客户端才会执行）。
- **简单**。不依赖外部库、单线程、只有 23000 行 Code。
- **主从复制**。主节点的数据做副本，这是做高可用的基石。
- **高可用和分布式**。Redis-Sentinel（v2.8）支持高可用，Redis-Cluster（v3.0）支持分布式。

#### 2. Redis 场景

Redis 最大的作用是增加你原来的访问性能问题，试想如果项目已经搭建好，这个项目一般是不太可能更换的。但是 Redis 独特的存在是只需要增加一层，把常用的数据存放在 Redis 即可。你在开发环境中使用 Redis 功能，但却不需要转到 Redis。

无论是什么架构，你都可以将 Redis 融入项目中来，这可以解决很多关系数据库无法解决的问题。比如，现有数据库处理缓慢的任务，或者在原有的基础上开发新的功能，都可以使用 Redis。接下来，我们一起看看 Redis 的典型使用场景。

- **缓存系统**

这是 Redis 使用最多的场景。Redis 能够替代 Memcached，让你的缓存从只能**存储数据**变得能够**更新数据**，因此你不再需要每次都重新生成数据。

毫无疑问，Redis 缓存使用的方式与 Memcached 相同。网络中总是能够看到这个技术更新换代，Redis 的原生命令，尽管简单却功能强大，把它们加以组合，能完成的功能是无法想象的。当然，你可以专门编写代码来完成所有这些操作，但 Redis 实现起来显然更为轻松。 ![enter image description here](http://images.gitbook.cn/2f2f40a0-e55b-11e7-a16c-c18ee1274508)

- **计数器**

如转发数、评论数，有了原子递增（Atomic Increment），你可以放心的加上各种计数，用 GETSET 重置，或者是让它们过期。目前新浪是号称史上最大的 Redis 集群。

比如，你想计算出最近用户在页面间停顿不超过 30 秒的页面浏览量，当计数达到比如 10 时，就可以显示提示。再比如，如果想知道什么时候封锁一个 IP 地址，INCRBY 命令让这些变得很容易，通过原子递增保持计数；GETSET 用来重置计数器；过期属性用来确认一个关键字什么时候应该删除。

- **消息队列系统**

虽然 Kafka 更强，但是简单的可以使用 Redis。运行稳定并且快速，支持模式匹配，能够实时订阅与取消频道。

Redis 还有阻塞队列的命令，能够让一个程序在执行时被另一个程序添加到队列。你也可以做些更有趣的事情，比如一个旋转更新的 RSS Feed 队列。

- **排行榜及相关问题**

排行榜实际就是一种有序集合。对于 Redis 来说，如果你要在几百万个用户中找到排名，其他数据库查询是非常慢的，因为每过几分钟，就会有几百万个不同的数据产生变化，但是 Redis 却可以轻松解决。

排行榜（Leader Board）按照得分进行排序。ZADD 命令可以直接实现这个功能，而 ZREVRANGE 命令可以用来按照得分获取前 100 名的用户，ZRANK 可以用来获取用户排名，非常直接而且操作容易。

- **社交网络**

Redis 可以非常好地与社交网络相结合，如新浪微博、Twiter 等，比如 QQ 和用户交互的时候，用户和状态消息将会聚焦很多有用的信息，很多交互如实时聊天就是通过 Redis 来实现的。

- **按照用户投票和时间排序**

Reddit 的排行榜，得分会随着时间变化。LPUSH 和 LTRIM 命令结合运用，把文章添加到一个列表中。一项后台任务用来获取列表，并重新计算列表的排序，ZADD 命令用来按照新的顺序填充生成列表。列表可以实现非常快速的检索，即使是负载很重的站点。

- **过期项目处理**

通过 Unix 时间作为关键字，用来保持列表能够按时间排序。对 current_time 和 time_to_live 进行检索，完成查找过期项目的艰巨任务。另一项后台任务使用 ZRANGE…WITHSCORES 进行查询，删除过期的条目。

- **实时系统**

使用位图来做布隆过滤器，例如实现垃圾邮件过滤系统的开发变得非常容易。

综上所述， Redis 的应用是非常广泛的，而且在实际使用中是非常有价值的。你可以让网站向 100 万用户推荐新闻、可以实时显示最新的项目列表、在游戏中实时获得排名、获得全球排名，等等。Redis 的出现，解决了传统关系数据库的短板，让开发变得更加简单和高效，大大提高了开发效率，也在用户体验上获得更加实时的体验。随着 Redis 的使用越来越广泛，将会有更多的开发者加入 Redis 的使用和开发上来。

### 1.3 小结

最后我们回顾下本文所讲述的内容。

首先，介绍了 Redis 主要是用于缓存系统的，不同于一般关系数据库。

其次，我们介绍了 Redis 的八大特性。通过这八大特性，我们可以把经常变化的数据放在 Redis 数据库中，并设置过期时间，到达时间 Redis 就会自动删除；还可以缓解服务器压力，如我们日常发微博，先会保存在 Redis 数据库中，然后等数据库压力比较小的时候保存进关系数据库中。

最后，我们介绍了 Redis 用在哪些场景下。

相信通过这些介绍，你应该对 Redis 有个比较详细的认识。接下去我们将实际使用 Redis。

> 拓展阅读：[Redis 实战场景详解](https://gitbook.cn/gitchat/activity/5c81ff36aa24bf22d670e335?utm_source=chcsd001)